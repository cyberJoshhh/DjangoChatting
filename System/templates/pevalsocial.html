{% extends 'base.html' %}

{% block content %}
{% load static %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<div class="evaluation-container">
    <div class="back-button-container">
        <a href="{% url 'dashboard' %}" class="back-button">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <h1 class="domain-title">Social-Emotional Domain</h1>
    
    <!-- Include the domain navigation -->
    {% include 'domain_nav.html' with active_domain='social' %}
    
    <div class="evaluation-table">
        <table>
            <thead>
                <tr>
                    <th class="social-col">Social-Emotional</th>
                    <th class="material-col">Material/Procedure</th>
                    <th class="eval-col">1st Eval</th>
                    <th class="eval-col">2nd Eval</th>
                    <th class="eval-col">3rd Eval</th>
                    <th class="comments-col">Comments</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1. Responds to adult activities or nearby children</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>2. Begins to recognize differences in emotions</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>3. Plays alone but likes to be near adults or brothers and sisters</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>4. Laughs or squeals about happy things</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>5. Uses speech-like babbling</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>7. Gets and interpretively into a sequence correctly</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>8. Hugs or cuddles toys, companions, parents</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>9. Demonstrates respect for others' belongings and space</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>10. Shows with pictures "sad" and "happy"</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>11. Shares toys with others (e.g., cooking, pababa)</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>12. Identifies feelings in others</td>
                    <td>Credit if the child can tell when the examiner is sad or hurt. Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>13. Appropriately uses words referring to mental states (e.g., know, think, etc.)</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>14. Tolerates feelings in others</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>15. Reacts when toys with a problem or someone to his wants</td>
                    <td>Credit if the child tries to solve the problem instead of crying when something doesn't go his way (e.g., attempting a toy with his reasons). Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>16. Helps the family chores (e.g., sweeping floors, watering plants, etc.)</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>18. Curious about environment but knows when to stop asking questions of adults</td>
                    <td>Credit if the child asks questions about things around him but knows when to stop asking if a topic. Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>19. Ask permission to play with his being used by another</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>20. Defends possessions with determination</td>
                    <td>Credit if the child tries to hold on to what is his when someone tries to grab him. Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>21. Helps organize group play</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>22. Can talk about complex feelings (e.g., anger, sadness, worry); he experiences</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>23. Cooperates with peers (e.g., plays outside only after school)</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>24. Interacts well with adults/siblings/family members</td>
                    <td>Parental report will suffice.</td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="checkbox"></td>
                    <td><input type="text" class="comment-input"></td>
                </tr>
                <tr>
                    <td>--</td>
                    <td colspan="1" class="total-row">TOTAL SCORE</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td></td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="submit-button-container">
        <button type="button" class="submit-button">
            <i class="fas fa-save"></i> Save Evaluation
        </button>
        <div id="loading-spinner" class="loading-spinner" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i> Generating PDF...
        </div>
    </div>
    
    <!-- Hidden fields for JavaScript -->
    <input type="hidden" id="studentName" value="{% if student and student.child_name %}{{ student.child_name }}{% else %}Unknown{% endif %}">
    <input type="hidden" id="generatePdfUrl" value="{% url 'generate_social_pdf' %}">
</div>

<style>
.back-button-container {
    margin-bottom: 1rem;
}

.back-button {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    background-color: #2d6a4f;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    transition: background-color 0.3s ease;
    font-weight: 500;
}

.back-button:hover {
    background-color: #1b4332;
    color: white;
}

.back-button i {
    margin-right: 0.5rem;
}

.evaluation-container {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.domain-title {
    color: #2d6a4f;
    margin-bottom: 2rem;
    font-size: 2rem;
    font-weight: 600;
}

.evaluation-table {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 1rem;
    border: 1px solid #e0e0e0;
    text-align: left;
}

th {
    background-color: #2d6a4f;
    color: white;
    font-weight: 500;
}

.social-col {
    width: 25%;
}

.material-col {
    width: 30%;
}

.eval-col {
    width: 8%;
    text-align: center;
}

.comments-col {
    width: 21%;
}

input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #2d6a4f;
}

.comment-input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.total-row {
    font-weight: 600;
    background-color: #f8f9fa;
}

tr:hover {
    background-color: #f8f9fa;
}

@media (max-width: 768px) {
    .back-button {
        font-size: 0.9rem;
        padding: 0.4rem 0.8rem;
    }
    
    .evaluation-container {
        padding: 1rem;
    }
    
    th, td {
        padding: 0.5rem;
        font-size: 0.9rem;
    }
}

td {
    transition: background-color 0.3s ease;
}

tr:last-child td {
    transition: background-color 0.3s ease;
}

.submit-button-container {
    margin-top: 2rem;
    text-align: center;
}

.submit-button {
    display: inline-flex;
    align-items: center;
    padding: 0.8rem 2rem;
    background-color: #2d6a4f;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 1.1rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.submit-button:hover {
    background-color: #1b4332;
}

.submit-button i {
    margin-right: 0.5rem;
}

/* Loading spinner */
.loading-spinner {
    margin-top: 1rem;
    text-align: center;
    color: #2d6a4f;
    font-size: 1.1rem;
    font-weight: 500;
}

.loading-spinner i {
    margin-right: 0.5rem;
    font-size: 1.2rem;
}

/* Modal Styles */
.modal {
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    position: relative;
    background-color: #fff;
    margin: 10% auto;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    width: 80%;
    max-width: 700px;
}

.close-button {
    position: absolute;
    top: 10px;
    right: 15px;
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close-button:hover {
    color: #333;
}

.modal h2 {
    color: #2d6a4f;
    margin-bottom: 1rem;
    font-size: 1.6rem;
}

#dbStatusContent {
    margin: 1rem 0;
    padding: 1rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #f8f9fa;
    max-height: 300px;
    overflow-y: auto;
}

#dbStatusContent p {
    margin: 0.5rem 0;
    line-height: 1.5;
}

.modal-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 1.5rem;
}

.modal-actions button {
    padding: 0.6rem 1.2rem;
    margin: 0 5px;
    flex: 1;
}

.success-message {
    color: #2d6a4f;
    font-weight: bold;
}

.error-message {
    color: #d32f2f;
    font-weight: bold;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function countCheckedBoxes(columnIndex) {
        let count = 0;
        const rows = document.querySelectorAll('tbody tr:not(:last-child)');
        rows.forEach(row => {
            const checkbox = row.querySelector(`td:nth-child(${columnIndex}) input[type="checkbox"]`);
            if (checkbox && checkbox.checked) {
                count++;
            }
        });
        return count;
    }

    function updateTotalScore() {
        // Get the total row cells
        const totalRow = document.querySelector('tbody tr:last-child');
        
        // Count and update for each evaluation column
        const firstEvalTotal = countCheckedBoxes(3);  // 3rd column (1st Eval)
        const secondEvalTotal = countCheckedBoxes(4); // 4th column (2nd Eval)
        const thirdEvalTotal = countCheckedBoxes(5);  // 5th column (3rd Eval)

        // Update the total cells
        totalRow.cells[2].textContent = firstEvalTotal;
        totalRow.cells[3].textContent = secondEvalTotal;
        totalRow.cells[4].textContent = thirdEvalTotal;

        // Add animation effect
        [2, 3, 4].forEach(index => {
            totalRow.cells[index].style.backgroundColor = '#e8f5e9';
            setTimeout(() => {
                totalRow.cells[index].style.backgroundColor = '';
            }, 500);
        });
    }

    // Add event listeners to checkboxes
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // Highlight the cell when checked
            const cell = this.parentElement;
            cell.style.backgroundColor = this.checked ? '#e8f5e9' : '';
            
            // Update the totals
            updateTotalScore();
        });
    });

    // Initialize totals on page load
    updateTotalScore();
    
    // Modal functionality
    const modal = document.getElementById('dbStatusModal');
    const closeButton = document.querySelector('.close-button');
    const viewPdfBtn = document.getElementById('viewPdfBtn');
    const returnToDashboardBtn = document.getElementById('returnToDashboardBtn');
    
    // Close modal when clicking the close button
    if (closeButton) {
        closeButton.addEventListener('click', function() {
            modal.style.display = 'none';
        });
    }
    
    // Close modal when clicking outside the modal content
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
    
    // Return to dashboard button
    if (returnToDashboardBtn) {
        returnToDashboardBtn.addEventListener('click', function() {
            window.location.href = "{% url 'dashboard' %}";
        });
    }
    
    // Updated submission function
    document.querySelector('.submit-button').addEventListener('click', function() {
        // Gather the data
        const totalRow = document.querySelector('tbody tr:last-child');
        const eval1Score = parseInt(totalRow.querySelector('td:nth-child(3)').textContent || '0');
        const eval2Score = parseInt(totalRow.querySelector('td:nth-child(4)').textContent || '0');
        const eval3Score = parseInt(totalRow.querySelector('td:nth-child(5)').textContent || '0');
        
        // Collect comments
        const comments = [];
        document.querySelectorAll('.comment-input').forEach((input, index) => {
            if (input.value) {
                comments.push({ number: index + 1, text: input.value });
            } else {
                comments.push({ number: index + 1, text: '' });
            }
        });
        
        // Also collect checkbox states for the PDF generation
        const checkboxData = [];
        const rows = document.querySelectorAll('tbody tr:not(:last-child)');
        rows.forEach((row, rowIndex) => {
            const rowNumber = rowIndex + 1;
            const checkboxes = [
                row.querySelector('td:nth-child(3) input[type="checkbox"]').checked,
                row.querySelector('td:nth-child(4) input[type="checkbox"]').checked,
                row.querySelector('td:nth-child(5) input[type="checkbox"]').checked
            ];
            checkboxData.push({ item: rowIndex, checked: checkboxes });
        });
        
        // Get student name or use "Unknown" if not available
        let studentName = "Unknown";
        // Using a JavaScript approach to get Django template variables
        const studentNameElement = document.getElementById('studentName');
        if (studentNameElement) {
            studentName = studentNameElement.value;
        }
        
        // Show loading state
        const saveButton = document.querySelector('.submit-button');
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        document.getElementById('loading-spinner').style.display = 'block';
        
        // Send data via AJAX
        console.log("Preparing to send evaluation data to server");
        console.log("Student name:", studentName);
        console.log("Scores:", eval1Score, eval2Score, eval3Score);
        console.log("Comments:", comments);
        console.log("Checkbox data:", checkboxData);
        
        let pdfUrl = ''; // Store PDF URL for later use
        
        fetch(document.getElementById('generatePdfUrl').value, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams({
                'student_name': studentName,
                'eval1_score': eval1Score,
                'eval2_score': eval2Score,
                'eval3_score': eval3Score,
                'comments': JSON.stringify(comments),
                'checkbox_data': JSON.stringify(checkboxData)
            })
        })
        .then(response => {
            console.log("Received response from server:", response.status);
            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("Received data from server:", data);
            saveButton.disabled = false;
            saveButton.innerHTML = '<i class="fas fa-save"></i> Save Evaluation';
            document.getElementById('loading-spinner').style.display = 'none';
            
            if (data.status === 'success') {
                // Save PDF URL for View PDF button
                pdfUrl = data.pdf_url;
                
                // Show database operation details in modal
                const dbStatusContent = document.getElementById('dbStatusContent');
                if (dbStatusContent) {
                    let htmlContent = `<p class="success-message">${data.database_status}</p>`;
                    htmlContent += '<p><strong>Database Operations:</strong></p>';
                    
                    if (data.db_operations && data.db_operations.length > 0) {
                        htmlContent += '<ul>';
                        data.db_operations.forEach(op => {
                            htmlContent += `<li>${op}</li>`;
                        });
                        htmlContent += '</ul>';
                    } else {
                        htmlContent += '<p>No database operations reported.</p>';
                    }
                    
                    dbStatusContent.innerHTML = htmlContent;
                }
                
                // Set the View PDF button URL
                if (viewPdfBtn) {
                    viewPdfBtn.addEventListener('click', function() {
                        window.open(pdfUrl, '_blank');
                    });
                }
                
                // Show the modal
                if (modal) {
                    modal.style.display = 'block';
                } else {
                    // Fallback if modal not found
                    alert('Evaluation saved and PDF generated successfully!');
                    if (confirm('Do you want to view the generated PDF?')) {
                        window.open(pdfUrl, '_blank');
                    }
                    window.location.href = "{% url 'dashboard' %}";
                }
            } else if (data.status === 'partial_success') {
                // Evaluation was saved but PDF generation failed
                alert('Evaluation data was saved, but the PDF could not be generated: ' + data.message);
                window.location.href = "{% url 'dashboard' %}";
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            saveButton.disabled = false;
            saveButton.innerHTML = '<i class="fas fa-save"></i> Save Evaluation';
            document.getElementById('loading-spinner').style.display = 'none';
            alert('An error occurred while saving the evaluation: ' + error.message);
        });
    });
});
</script>

<!-- Add CSRF Token -->
{% csrf_token %}

<!-- Add hidden fields for student information -->
{% if student %}
<input type="hidden" id="student-id" value="{{ student.id }}">
<input type="hidden" id="student-name" value="{{ student.child_name }}">
{% else %}
<input type="hidden" id="student-id" value="">
<input type="hidden" id="student-name" value="Unknown Student">
{% endif %}
{% endblock %} 