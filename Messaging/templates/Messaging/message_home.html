{% extends 'base.html' %}
{% load static %}

{% block title %}Messages{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
{% if not user.is_staff %}
<link rel="stylesheet" href="{% static 'css/pdash.css' %}">
{% endif %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">

<style>
    :root {
        --primary-color: #2d6a4f;
        --secondary-color: #1b4332;
        --light-color: #f8f9fa;
        --dark-color: #212529;
        --sent-msg-color: #dcf8c6;
        --received-msg-color: #f0f0f0;
        --sidebar-bg: linear-gradient(135deg, #2d6a4f, #1b4332);
        --accent-color: #52b788;
        --border-radius: 12px;
        --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #f8f9fa;
    }
    
    /* Chat interface layout */
    .chat-interface {
        display: flex;
        flex-direction: column;
        height: 100%;
        border-radius: var(--border-radius);
        background-color: white;
        box-shadow: var(--box-shadow);
        overflow: hidden;
    }
    
    /* Parent sidebar customization styles */
    body[data-is-staff="false"] a[href*="comparison_view"], 
    body[data-is-staff="false"] a[href*="add_student"] {
        display: none !important;
    }
    
    /* Chat interface layout */
    .chat-interface {
        display: flex;
        flex-direction: column;
        height: 100%;
        border-radius: var(--border-radius);
        background-color: white;
        box-shadow: var(--box-shadow);
        overflow: hidden;
    }
    
    .d-none {
        display: none !important;
    }
    
    .chat-interface.d-none {
        display: none !important;
    }
    
    .chat-interface:not(.d-none) {
        display: flex !important;
    }
    
    /* Content layout */
    .messaging-content {
        margin-left: 250px;
        width: calc(100% - 250px);
        transition: margin-left 0.3s ease;
        position: relative;
        z-index: 1;
        padding: 20px;
    }
    
    /* Sidebar styling for teachers */
    body[data-is-staff="true"] #sidebar {
        background: var(--sidebar-bg) !important;
        color: white !important;
        z-index: 1000 !important;
        position: fixed !important;
        left: 0 !important;
        top: 0 !important;
        display: block !important;
        height: 100vh !important;
        width: 250px !important;
        padding: 20px !important;
        box-shadow: var(--box-shadow) !important;
        transition: transform 0.3s ease !important;
        transform: translateX(0) !important;
        will-change: transform;
        pointer-events: auto !important;
    }
    
    /* Ensure parent sidebar doesn't get overridden */
    body[data-is-staff="false"] #sidebar {
        z-index: 1001 !important;
    }
    
    .sidebar-header h2, .sidebar-header h3 {
        color: white !important;
    }
    
    .sidebar-btn, .logout-btn {
        color: white !important;
        pointer-events: auto !important;
        transition: all 0.2s ease;
        border-radius: 8px;
        padding: 10px 15px;
    }
    
    .sidebar-btn:hover, .logout-btn:hover {
        background: rgba(255,255,255,0.1);
        transform: translateX(5px);
    }
    
    /* Tabs styling */
    .nav-pills .nav-link {
        cursor: pointer;
        color: var(--primary-color);
        font-weight: 500;
        pointer-events: auto !important;
        border-radius: 8px;
        margin-bottom: 8px;
        transition: all 0.2s ease;
    }
    
    .nav-pills .nav-link:hover {
        background-color: rgba(67, 97, 238, 0.1);
    }
    
    .nav-pills .nav-link.active {
        background-color: var(--primary-color);
        color: white;
        box-shadow: 0 4px 8px rgba(67, 97, 238, 0.3);
    }
    
    .tab-content {
        display: block;
        width: 100%;
    }
    
    .tab-pane {
        opacity: 0;
        height: 0;
        overflow: hidden;
        transition: opacity 0.3s;
    }
    
    .tab-pane.active,
    .tab-pane.show.active {
        opacity: 1;
        height: auto;
        overflow: visible;
    }
    
    /* Contact and group list */
    .group-list, .contact-list {
        max-height: 60vh;
        overflow-y: auto;
        pointer-events: auto !important;
        border-radius: var(--border-radius);
        padding: 0;
        margin-top: 10px;
    }
    
    .contact-item, .group-item {
        cursor: pointer !important;
        pointer-events: auto !important;
        border: none !important;
        margin-bottom: 8px !important;
        border-radius: 8px !important;
        transition: all 0.2s ease !important;
        background-color: white !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05) !important;
    }
    
    .contact-item:hover, .group-item:hover {
        background-color: #f8f9fa !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
    }
    
    /* Mobile menu toggle */
    #mobileMenuToggle {
        display: none;
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 1100;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        font-size: 1.2rem;
        cursor: pointer;
        box-shadow: var(--box-shadow);
        pointer-events: auto !important;
    }
    
    /* Chat area */
    .chat-area {
        padding: 0 !important;
    }
    
    .welcome-screen {
        background-color: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 40px !important;
    }
    
    .welcome-screen i {
        color: var(--primary-color) !important;
        font-size: 5rem !important;
    }
    
    .chat-header {
        background-color: white;
        padding: 15px 20px !important;
        border-bottom: 1px solid rgba(0,0,0,0.1) !important;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .chat-header h5 {
        margin: 0;
        font-weight: 600;
        color: var(--dark-color);
    }
    
    .chat-messages {
        background-color: #f8f9fa;
        padding: 20px !important;
        min-height: calc(70vh - 130px) !important;
        max-height: calc(70vh - 130px) !important;
        overflow-y: auto;
    }
    
    .chat-input {
        background-color: white;
        padding: 15px 20px !important;
        border-top: 1px solid rgba(0,0,0,0.1);
    }
    
    .chat-input .form-control {
        border-radius: 24px;
        padding: 12px 20px;
        box-shadow: none;
        border: 1px solid rgba(0,0,0,0.1);
    }
    
    .chat-input .btn {
        border-radius: 24px;
        padding: 8px 20px;
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        box-shadow: 0 2px 5px rgba(67, 97, 238, 0.3);
    }
    
    .chat-input .btn:hover {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(67, 97, 238, 0.4);
    }
    
    /* Messages styling */
    .message-item {
        margin-bottom: 20px;
        display: flex;
        position: relative;
    }
    
    .message-item.sent {
        justify-content: flex-end;
    }
    
    .message-bubble {
        max-width: 70%;
        padding: 12px 18px;
        border-radius: 18px;
        background-color: var(--received-msg-color);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        position: relative;
    }
    
    .message-item.received .message-bubble {
        border-bottom-left-radius: 5px;
    }
    
    .message-item.sent .message-bubble {
        background-color: var(--sent-msg-color);
        border-bottom-right-radius: 5px;
        box-shadow: 0 1px 3px rgba(67, 97, 238, 0.2);
    }
    
    .message-sender {
        font-weight: 600;
        font-size: 0.8rem;
        margin-bottom: 5px;
        color: var(--primary-color);
    }
    
    .message-text {
        word-wrap: break-word;
        font-size: 0.95rem;
    }
    
    .message-time {
        font-size: 0.7rem;
        color: #777;
        text-align: right;
        margin-top: 5px;
    }
    
    /* Modal styling */
    .modal-content {
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
    }
    
    .modal-header {
        background-color: var(--primary-color);
        color: white;
        border-radius: calc(var(--border-radius) - 1px) calc(var(--border-radius) - 1px) 0 0;
    }
    
    .modal-title {
        font-weight: 600;
    }
    
    .modal-header .close {
        color: white;
    }
    
    .form-group label {
        font-weight: 500;
    }
    
    .custom-control-label {
        cursor: pointer;
    }
    
    .member-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 8px;
        padding: 10px;
    }
    
    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .btn-primary:hover {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
    }
    
    /* Responsive styling */
    @media (max-width: 992px) {
        .messaging-content {
            margin-left: 80px;
            width: calc(100% - 80px);
        }
        
        body[data-is-staff="true"] #sidebar {
            width: 80px !important;
            padding: 15px 10px !important;
        }
        
        .sidebar-header h2, .sidebar-header h3, .sidebar-btn span {
            display: none !important;
        }
        
        .sidebar-btn i {
            font-size: 1.5rem !important;
            margin-right: 0 !important;
        }
        
        .contacts-sidebar {
            padding: 0 10px;
        }
    }
    
    @media (max-width: 576px) {
        .messaging-content {
            margin-left: 0;
            width: 100%;
            padding-top: 60px;
            transition: margin-left 0.3s ease;
        }
        
        body[data-is-staff="true"] #sidebar {
            transform: translateX(-100%) !important;
            width: 250px !important;
            transition: transform 0.3s ease !important;
            left: 0 !important;
        }
        
        body[data-is-staff="true"] #sidebar.active {
            transform: translateX(0) !important;
        }
        
        #mobileMenuToggle {
            display: block;
        }
        
        .sidebar-header h2, .sidebar-header h3, .sidebar-btn span {
            display: inline-block !important;
        }
        
        .row {
            margin: 0;
        }
        
        .contacts-sidebar {
            padding: 0;
            margin-bottom: 15px;
        }
        
        .col-md-3, .col-md-9 {
            padding: 0;
        }
    }
    
    /* File attachment and display styles */
    .attachment-btn {
        background-color: transparent;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        font-size: 1.2rem;
        padding: 8px 10px;
        transition: all 0.2s ease;
    }
    
    .attachment-btn:hover {
        color: var(--secondary-color);
        transform: scale(1.1);
    }
    
    .pdf-attachment {
        display: flex;
        align-items: center;
        background-color: rgba(45, 106, 79, 0.1);
        border-radius: 8px;
        padding: 8px 12px;
        margin-top: 8px;
        max-width: 250px;
    }
    
    .pdf-attachment i {
        color: #e74c3c;
        font-size: 1.5rem;
        margin-right: 10px;
    }
    
    .pdf-attachment-name {
        font-size: 0.9rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-grow: 1;
    }
    
    .pdf-attachment-download {
        color: var(--primary-color);
        margin-left: 8px;
        font-size: 0.9rem;
    }
    
    .document-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .document-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .document-item:hover {
        background-color: rgba(45, 106, 79, 0.1);
    }
    
    .document-item i {
        font-size: 1.5rem;
        margin-right: 10px;
        color: #e74c3c;
    }
    
    .document-info {
        flex-grow: 1;
    }
    
    .document-name {
        font-weight: 500;
        margin-bottom: 2px;
    }
    
    .document-meta {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .selected-document {
        background-color: rgba(45, 106, 79, 0.2);
    }
    
    #selectedFileDisplay {
        display: none;
        align-items: center;
        background-color: rgba(45, 106, 79, 0.1);
        border-radius: 8px;
        padding: 5px 10px;
        margin-bottom: 10px;
        width: 100%;
    }
    
    #selectedFileName {
        flex-grow: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-left: 8px;
    }
    
    #removeSelectedFile {
        color: #e74c3c;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0 5px;
    }
    
    /* Hide teacher-specific sidebar items from parents */
    body:not([data-is-staff="true"]) .teacher-only {
        display: none !important;
    }
    
    /* Ensure parent-specific items are only shown to parents */
    body:not([data-is-staff="false"]) .parent-only {
        display: none !important;
    }
    
    /* Additional styling for parent sidebar */
    body[data-is-staff="false"] #sidebar {
        background: linear-gradient(135deg, #2d6a4f, #1b4332) !important;
    }
    
    body[data-is-staff="false"] .sidebar-btn:hover {
        background: rgba(255,255,255,0.15);
    }
</style>
{% endblock %}

{% block content %}
<!-- Add data attribute to the body tag through JavaScript to pass user role -->
<script>
    document.body.setAttribute('data-is-staff', '{% if user.is_staff %}true{% else %}false{% endif %}');
    document.body.setAttribute('data-user-id', '{{ user.id }}');
</script>

<!-- Include the appropriate sidebar based on user role -->
{% if user.is_staff %}
    {% include 'sidebar.html' %}
{% else %}
    {% include 'sidebar_parent.html' %}
{% endif %}

<div class="container-fluid messaging-content">
    <div class="row">
        <!-- Contacts sidebar -->
        <div class="col-md-3 border-right contacts-sidebar">
            <div class="d-flex flex-column h-100 bg-white p-3 rounded shadow-sm">
                <div class="contacts-header py-3">
                    <h4 class="mb-0 font-weight-bold">Messages</h4>
                    {% if user.is_staff %}
                    <button class="btn btn-sm btn-primary mt-3" id="createGroupBtn">
                        <i class="fas fa-users mr-1"></i> Create Group
                    </button>
                    {% endif %}
                </div>
                
                <ul class="nav flex-column nav-pills mt-3" id="v-pills-tab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active d-flex align-items-center" id="direct-messages-tab" data-toggle="pill" href="#direct-messages" role="tab" aria-controls="direct-messages" aria-selected="true">
                            <i class="fas fa-user mr-2"></i> Direct Messages
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link d-flex align-items-center" id="group-messages-tab" data-toggle="pill" href="#group-messages" role="tab" aria-controls="group-messages" aria-selected="false">
                            <i class="fas fa-users mr-2"></i> Group Chats
                        </a>
                    </li>
                </ul>
                
                <div class="tab-content flex-grow-1 mt-3" id="v-pills-tabContent">
                    <!-- Direct message contacts -->
                    <div class="tab-pane fade show active" id="direct-messages" role="tabpanel" aria-labelledby="direct-messages-tab">
                        <div class="list-group contact-list">
                            {% for contact in users %}
                            <a href="javascript:void(0);" class="list-group-item list-group-item-action contact-item" data-id="{{ contact.id }}">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-user-circle mr-2 text-primary"></i>
                                        <span>{{ contact.username }}</span>
                                    </div>
                                    <span class="badge badge-primary badge-pill unread-badge d-none" data-user="{{ contact.id }}">0</span>
                                </div>
                            </a>
                            {% empty %}
                            <div class="text-center text-muted py-4 bg-light rounded">
                                <i class="fas fa-user-slash mb-2" style="font-size: 2rem;"></i>
                                <p>No contacts available</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Group chats -->
                    <div class="tab-pane fade" id="group-messages" role="tabpanel" aria-labelledby="group-messages-tab">
                        <div class="list-group group-list">
                            {% for group in chat_groups %}
                            <a href="javascript:void(0);" class="list-group-item list-group-item-action group-item" data-id="{{ group.id }}">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-users mr-2 text-primary"></i>
                                        <span>{{ group.name }}</span>
                                    </div>
                                </div>
                            </a>
                            {% empty %}
                            <div class="text-center text-muted py-4 bg-light rounded">
                                <i class="fas fa-users-slash mb-2" style="font-size: 2rem;"></i>
                                <p>No group chats available</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat area -->
        <div class="col-md-9 chat-area">
            <div class="welcome-screen text-center py-5" id="welcomeScreen">
                <div class="welcome-icon mb-4">
                    <i class="fas fa-comments" style="font-size: 4rem;"></i>
                </div>
                <h3 class="font-weight-bold">Welcome to Messages</h3>
                <p class="text-muted">Select a contact or group to start messaging</p>
                <div class="welcome-hint mt-4">
                    <div class="d-flex justify-content-center">
                        <div class="hint-item mx-3 text-center">
                            <i class="fas fa-user-circle mb-2" style="font-size: 2rem; color: var(--primary-color);"></i>
                            <p>Direct Messages</p>
                        </div>
                        <div class="hint-item mx-3 text-center">
                            <i class="fas fa-users mb-2" style="font-size: 2rem; color: var(--secondary-color);"></i>
                            <p>Group Chats</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-interface d-none">
                <div class="chat-header border-bottom p-3">
                    <h5 id="chatName"></h5>
                </div>
                
                <div class="chat-messages p-3" id="messageContainer">
                    <!-- Messages will be loaded here -->
                </div>
                
                <div class="chat-input border-top p-3">
                    <div id="selectedFileDisplay">
                        <i class="fas fa-file-pdf" style="color: #e74c3c;"></i>
                        <span id="selectedFileName"></span>
                        <button id="removeSelectedFile"><i class="fas fa-times"></i></button>
                    </div>
                    <form id="messageForm">
                        <div class="input-group">
                            <button type="button" class="attachment-btn" id="attachmentBtn" title="Attach PDF">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <input type="text" class="form-control" id="messageInput" placeholder="Type a message...">
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="submit">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Group Modal -->
{% if user.is_staff %}
<div class="modal fade" id="createGroupModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Group Chat</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createGroupForm">
                    <div class="form-group">
                        <label for="groupName">Group Name</label>
                        <input type="text" class="form-control" id="groupName" required>
                    </div>
                    <div class="form-group">
                        <label>Select Members</label>
                        <div class="member-list">
                            {% for user in users %}
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="member-{{ user.id }}" value="{{ user.id }}">
                                <label class="custom-control-label" for="member-{{ user.id }}">{{ user.username }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveGroupBtn">Create Group</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Add PDF Attachment Modal -->
<div class="modal fade" id="pdfAttachmentModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select PDF to Attach</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" class="form-control" id="pdfSearchInput" placeholder="Search PDFs...">
                </div>
                <div class="document-list" id="pdfList">
                    <!-- Documents will be loaded here -->
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2">Loading documents...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="selectPdfBtn" disabled>Attach Selected PDF</button>
            </div>
        </div>
    </div>
</div>

<!-- Messaging-specific JavaScript -->
<script>
// Variables for user type will be initialized in the script
var userIsStaff, currentUsername;
var currentChatId = null;
var currentChatType = null;
var currentGroupName = null;
var selectedPdfId = null;
var selectedPdfName = null;

// Direct fix to ensure chat interface shows
document.addEventListener('DOMContentLoaded', function() {
    console.log('Direct fix script loaded');
    
    // Set user type based on data attribute (set below in the HTML)
    userIsStaff = document.body.getAttribute('data-is-staff') === 'true';
    currentUsername = userIsStaff ? 'Teacher' : 'Parent';
    
    console.log('User is staff:', userIsStaff);
    
    // Fix tab switching
    const directMessagesTab = document.getElementById('direct-messages-tab');
    const groupMessagesTab = document.getElementById('group-messages-tab');
    const directMessagesPane = document.getElementById('direct-messages');
    const groupMessagesPane = document.getElementById('group-messages');
    
    // Ensure tabs switch correctly
    if (directMessagesTab && groupMessagesTab) {
        directMessagesTab.addEventListener('click', function(e) {
            e.preventDefault();
            // Activate direct messages tab
            directMessagesTab.classList.add('active');
            groupMessagesTab.classList.remove('active');
            
            // Show direct messages content
            directMessagesPane.classList.add('show', 'active');
            groupMessagesPane.classList.remove('show', 'active');
            
            console.log('Switched to direct messages tab');
        });
        
        groupMessagesTab.addEventListener('click', function(e) {
            e.preventDefault();
            // Activate group messages tab
            groupMessagesTab.classList.add('active');
            directMessagesTab.classList.remove('active');
            
            // Show group messages content
            groupMessagesPane.classList.add('show', 'active');
            directMessagesPane.classList.remove('show', 'active');
            
            console.log('Switched to group messages tab');
        });
    }
    
    // Handle Create Group Button for teachers
    const createGroupBtn = document.getElementById('createGroupBtn');
    const createGroupModal = document.getElementById('createGroupModal');
    
    if (createGroupBtn && createGroupModal) {
        createGroupBtn.addEventListener('click', function() {
            // Check if Bootstrap 4 is available
            if (typeof $ !== 'undefined' && typeof $.fn.modal !== 'undefined') {
                $('#createGroupModal').modal('show');
            } else {
                // Fallback if jQuery/Bootstrap is not available
                createGroupModal.style.display = 'block';
                createGroupModal.classList.add('show');
                document.body.classList.add('modal-open');
                
                // Add backdrop
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(backdrop);
                
                // Handle close button
                const closeButtons = createGroupModal.querySelectorAll('[data-dismiss="modal"]');
                closeButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        createGroupModal.style.display = 'none';
                        createGroupModal.classList.remove('show');
                        document.body.classList.remove('modal-open');
                        document.body.removeChild(backdrop);
                    });
                });
            }
        });

        // Handle save group button
        const saveGroupBtn = document.getElementById('saveGroupBtn');
        if (saveGroupBtn) {
            saveGroupBtn.addEventListener('click', function() {
                const groupName = document.getElementById('groupName').value.trim();
                if (!groupName) {
                    alert('Please enter a group name');
                    return;
                }
                
                // Get selected members
                const members = [];
                document.querySelectorAll('.member-list input[type="checkbox"]:checked').forEach(checkbox => {
                    members.push(checkbox.value);
                });
                
                if (members.length === 0) {
                    alert('Please select at least one member');
                    return;
                }
                
                // Create the group via API
                createGroup(groupName, members);
                
                // Close the modal
                if (typeof $ !== 'undefined' && typeof $.fn.modal !== 'undefined') {
                    $('#createGroupModal').modal('hide');
                } else {
                    createGroupModal.style.display = 'none';
                    createGroupModal.classList.remove('show');
                    document.body.classList.remove('modal-open');
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) document.body.removeChild(backdrop);
                }
            });
        }
    }
    
    // Enhanced direct fix for showing chat interface - now with real-time data
    const contactItems = document.querySelectorAll('.contact-item');
    contactItems.forEach(item => {
        item.addEventListener('click', function(event) {
            event.preventDefault();
            
            // Get user ID
            const userId = this.getAttribute('data-id');
            const name = this.querySelector('span').textContent;
            
            // Show chat interface
            showChatInterface(name, userId, 'direct');
            
            // Load messages from API
            loadDirectMessages(userId);
        });
    });
    
    // Handle group chat clicks
    const groupItems = document.querySelectorAll('.group-item');
    groupItems.forEach(item => {
        item.addEventListener('click', function(event) {
            event.preventDefault();
            
            // Get group ID
            const groupId = this.getAttribute('data-id');
            const name = this.querySelector('span').textContent;
            
            // Show chat interface
            showChatInterface(name, groupId, 'group');
            
            // Load messages from API
            loadGroupMessages(groupId);
        });
    });
    
    // PDF attachment functionality
    const attachmentBtn = document.getElementById('attachmentBtn');
    const pdfAttachmentModal = document.getElementById('pdfAttachmentModal');
    const selectPdfBtn = document.getElementById('selectPdfBtn');
    const selectedFileDisplay = document.getElementById('selectedFileDisplay');
    const selectedFileName = document.getElementById('selectedFileName');
    const removeSelectedFile = document.getElementById('removeSelectedFile');
    const pdfSearchInput = document.getElementById('pdfSearchInput');
    
    // Open PDF attachment modal
    if (attachmentBtn && pdfAttachmentModal) {
        attachmentBtn.addEventListener('click', function() {
            // Only teachers can attach files
            if (!userIsStaff) {
                alert('Only teachers can attach files');
                return;
            }
            
            console.log('Opening PDF attachment modal');
            
            // Open the modal
            if (typeof $ !== 'undefined' && typeof $.fn.modal !== 'undefined') {
                $('#pdfAttachmentModal').modal('show');
                // Load PDFs when modal opens
                loadPdfsFromDatabase();
            } else {
                // Fallback
                console.log('jQuery not available, using fallback modal opening');
                pdfAttachmentModal.style.display = 'block';
                pdfAttachmentModal.classList.add('show');
                document.body.classList.add('modal-open');
                
                // Add backdrop
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(backdrop);
                
                // Load PDFs
                loadPdfsFromDatabase();
                
                // Handle close buttons
                const closeButtons = pdfAttachmentModal.querySelectorAll('[data-dismiss="modal"]');
                closeButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        pdfAttachmentModal.style.display = 'none';
                        pdfAttachmentModal.classList.remove('show');
                        document.body.classList.remove('modal-open');
                        document.body.removeChild(backdrop);
                    });
                });
            }
        });
    }
    
    // Search PDFs
    if (pdfSearchInput) {
        pdfSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const documentItems = document.querySelectorAll('.document-item');
            
            documentItems.forEach(item => {
                const documentName = item.querySelector('.document-name').textContent.toLowerCase();
                if (documentName.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
    
    // Handle PDF selection
    if (selectPdfBtn) {
        selectPdfBtn.addEventListener('click', function() {
            if (selectedPdfId) {
                // Display selected file
                selectedFileDisplay.style.display = 'flex';
                selectedFileName.textContent = selectedPdfName;
                
                // Close modal
                if (typeof $ !== 'undefined' && typeof $.fn.modal !== 'undefined') {
                    $('#pdfAttachmentModal').modal('hide');
                } else {
                    pdfAttachmentModal.style.display = 'none';
                    pdfAttachmentModal.classList.remove('show');
                    document.body.classList.remove('modal-open');
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) document.body.removeChild(backdrop);
                }
            }
        });
    }
    
    // Remove selected file
    if (removeSelectedFile) {
        removeSelectedFile.addEventListener('click', function() {
            selectedPdfId = null;
            selectedPdfName = null;
            selectedFileDisplay.style.display = 'none';
            selectedFileName.textContent = '';
        });
    }
    
    // Handle form submission for messages - now with PDF attachment support
    const messageForm = document.getElementById('messageForm');
    if (messageForm) {
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if ((message || selectedPdfId) && currentChatId) {
                // Send message based on chat type
                if (currentChatType === 'direct') {
                    sendDirectMessage(currentChatId, message, selectedPdfId);
                } else if (currentChatType === 'group') {
                    sendGroupMessage(currentChatId, message, selectedPdfId);
                }
                
                // Clear input and attachment
                messageInput.value = '';
                selectedPdfId = null;
                selectedPdfName = null;
                selectedFileDisplay.style.display = 'none';
                selectedFileName.textContent = '';
            }
        });
    }
    
    // Basic mobile menu toggle functionality
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    if (mobileMenuToggle) {
        mobileMenuToggle.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent event bubbling
            // Since PDash sidebar handling is included in sidebar_parent.html, 
            // we only need to handle toggle for teacher users here
            if (userIsStaff) {
                const sidebar = document.getElementById('sidebar');
                const sidebarOverlay = document.getElementById('sidebarOverlay');
                if (sidebar) {
                    sidebar.classList.toggle('active');
                }
                if (sidebarOverlay) {
                    sidebarOverlay.classList.toggle('active');
                }
            }
        });
    }
    
    // Functions for PDF attachments
    
    // Load PDFs from database
    function loadPdfsFromDatabase() {
        console.log('Loading PDFs from database');
        const pdfList = document.getElementById('pdfList');
        
        // Show loading
        if (pdfList) {
            pdfList.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-2">Loading documents...</p>
                </div>
            `;
        }
        
        // Call API to get PDFs
        fetch('/messaging/get_documents/')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`Loaded ${data.documents ? data.documents.length : 0} PDF documents`);
                console.log('Sample document data:', data.documents && data.documents.length > 0 ? data.documents[0] : 'No documents');
                // Render PDFs
                renderPdfList(data.documents);
            })
            .catch(error => {
                console.error('Error loading PDFs:', error);
                if (pdfList) {
                    pdfList.innerHTML = `
                        <div class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-circle mb-2" style="font-size: 2rem;"></i>
                            <p>Error loading documents: ${error.message}</p>
                        </div>
                    `;
                }
            });
    }
    
    // Render PDF list
    function renderPdfList(documents) {
        const pdfList = document.getElementById('pdfList');
        
        if (!pdfList) return;
        
        if (!documents || documents.length === 0) {
            pdfList.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-file-pdf mb-2" style="font-size: 2rem; color: #ccc;"></i>
                    <p>No documents available</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        documents.forEach(document => {
            const date = new Date(document.uploaded_at).toLocaleDateString();
            html += `
                <div class="document-item" data-id="${document.id}" data-name="${document.name}">
                    <i class="fas fa-file-pdf"></i>
                    <div class="document-info">
                        <div class="document-name">${document.name}</div>
                        <div class="document-meta">Uploaded: ${date} | Size: ${formatFileSize(document.size)}</div>
                    </div>
                </div>
            `;
        });
        
        pdfList.innerHTML = html;
        
        // Add click event to select document
        document.querySelectorAll('.document-item').forEach(item => {
            item.addEventListener('click', function() {
                // Remove selected class from all items
                document.querySelectorAll('.document-item').forEach(i => {
                    i.classList.remove('selected-document');
                });
                
                // Add selected class to clicked item
                this.classList.add('selected-document');
                
                // Store selected PDF ID and name
                selectedPdfId = this.getAttribute('data-id');
                selectedPdfName = this.getAttribute('data-name');
                
                // Enable select button
                document.getElementById('selectPdfBtn').disabled = false;
            });
        });
    }
    
    // Format file size
    function formatFileSize(bytes) {
        if (!bytes || isNaN(bytes)) return '0 B';
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    // Functions for real-time messaging
    
    // Show chat interface function
    function showChatInterface(name, id, type) {
        // Update current chat tracking
        currentChatId = id;
        currentChatType = type;
        if (type === 'group') {
            currentGroupName = name;
        }
            
        // Show chat interface directly
        document.querySelector('.welcome-screen').style.display = 'none';
        const chatInterface = document.querySelector('.chat-interface');
        chatInterface.style.display = 'flex';
        chatInterface.style.flexDirection = 'column';
        chatInterface.classList.remove('d-none');
            
        // Set chat header
        const chatHeader = document.querySelector('.chat-header');
        if (chatHeader) {
            if (type === 'group') {
                // For group chats, include a simple header without the View Members button
                chatHeader.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <h5 id="chatName" data-id="${id}" data-type="${type}">${name} <span class="badge badge-info">Group</span></h5>
                    </div>
                `;
            } else {
                // For direct messages, just show the name
                chatHeader.innerHTML = `<h5 id="chatName" data-id="${id}" data-type="${type}">${name}</h5>`;
            }
        }
        
        // Show loading in message container
        const messageContainer = document.getElementById('messageContainer');
        if (messageContainer) {
            messageContainer.innerHTML = '<div class="text-center my-4"><p>Loading messages...</p></div>';
        }
            
        // Close sidebar on mobile when selecting a contact
        const isSmallScreen = window.innerWidth <= 576;
        if (isSmallScreen) {
            const sidebar = document.getElementById('sidebar');
            if (sidebar && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                const overlay = document.getElementById('sidebarOverlay');
                if (overlay) overlay.classList.remove('active');
            }
        }
    }
    
    // Load direct messages from API
    function loadDirectMessages(userId) {
        console.log(`Loading direct messages with user ID: ${userId}`);
        fetch(`/messaging/get_messages/?user_id=${userId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log(`Received ${data.messages ? data.messages.length : 0} messages`);
                displayMessages(data.messages);
            })
            .catch(error => {
                console.error('Error loading messages:', error);
                const messageContainer = document.getElementById('messageContainer');
                if (messageContainer) {
                    messageContainer.innerHTML = '<div class="text-center my-4 text-danger"><p>Error loading messages. Please try again.</p></div>';
                }
            });
    }
    
    // Load group messages from API
    function loadGroupMessages(groupId) {
        console.log(`Loading group messages for group ID: ${groupId}`);
        fetch(`/messaging/get_group_messages/?group_id=${groupId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log(`Received ${data.messages ? data.messages.length : 0} group messages`);
                displayMessages(data.messages);
            })
            .catch(error => {
                console.error('Error loading group messages:', error);
                const messageContainer = document.getElementById('messageContainer');
                if (messageContainer) {
                    messageContainer.innerHTML = '<div class="text-center my-4 text-danger"><p>Error loading group messages. Please try again.</p></div>';
                }
            });
    }
    
    // Display messages in the container with PDF support
    function displayMessages(messages) {
        console.log('Displaying messages:', messages);
        const messageContainer = document.getElementById('messageContainer');
        if (!messageContainer) {
            console.error('Message container not found in DOM');
            return;
        }
        
        if (!messages || messages.length === 0) {
            messageContainer.innerHTML = '<div class="text-center my-4"><p>No messages yet. Start a conversation!</p></div>';
            return;
        }
        
        let html = '';
        messages.forEach(message => {
            try {
                const messageClass = message.is_mine ? 'sent' : 'received';
                const senderInfo = message.is_mine ? `You (${currentUsername})` : message.sender;
                
                let attachmentHtml = '';
                if (message.attachment) {
                    console.log('Message has attachment:', message.attachment);
                    try {
                        // Make sure we have all required data for the attachment
                        if (message.attachment.name && message.attachment.url) {
                            attachmentHtml = `
                                <div class="pdf-attachment">
                                    <i class="fas fa-file-pdf"></i>
                                    <div class="pdf-attachment-name">${message.attachment.name}</div>
                                    <a href="${message.attachment.url}" class="pdf-attachment-download" target="_blank">
                                        <i class="fas fa-download"></i>
                                    </a>
                                </div>
                            `;
                        } else {
                            console.warn('Attachment missing name or URL:', message.attachment);
                            attachmentHtml = `
                                <div class="pdf-attachment">
                                    <i class="fas fa-file-pdf"></i>
                                    <div class="pdf-attachment-name">PDF Document</div>
                                    <span class="pdf-attachment-download text-warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </span>
                                </div>
                            `;
                        }
                    } catch (attachError) {
                        console.error('Error processing attachment:', attachError);
                        attachmentHtml = '';
                    }
                }
                
                html += `
                    <div class="message-item ${messageClass}">
                        <div class="message-bubble">
                            <div class="message-sender">${senderInfo}</div>
                            <div class="message-text">${message.content || ''}</div>
                            ${attachmentHtml}
                            <div class="message-time">${message.timestamp || new Date().toLocaleString()}</div>
                        </div>
                    </div>
                `;
            } catch (messageError) {
                console.error('Error processing message:', messageError, message);
                // Skip this message
            }
        });
        
        if (html) {
            messageContainer.innerHTML = html;
            messageContainer.scrollTop = messageContainer.scrollHeight;
        } else {
            messageContainer.innerHTML = '<div class="text-center my-4 text-danger"><p>Error displaying messages. Please try refreshing.</p></div>';
        }
    }
    
    // Send direct message to API with attachment support
    function sendDirectMessage(recipientId, content, attachmentId) {
        const messageContainer = document.getElementById('messageContainer');
        
        // Add message to UI first for responsive feel
        const tempId = 'temp-' + Date.now();
        const now = new Date();
        const hours = now.getHours() % 12 || 12;
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const ampm = now.getHours() >= 12 ? 'PM' : 'AM';
        const timeString = `${hours}:${minutes} ${ampm}`;
        
        let attachmentHtml = '';
        if (attachmentId && selectedPdfName) {
            attachmentHtml = `
                <div class="pdf-attachment">
                    <i class="fas fa-file-pdf"></i>
                    <div class="pdf-attachment-name">${selectedPdfName}</div>
                    <span class="pdf-attachment-download">
                        <i class="fas fa-clock"></i>
                    </span>
                </div>
            `;
        }
        
        const tempMessage = `
            <div class="message-item sent" id="${tempId}">
                <div class="message-bubble">
                    <div class="message-sender">You (${currentUsername})</div>
                    <div class="message-text">${content}</div>
                    ${attachmentHtml}
                    <div class="message-time">${timeString} (Sending...)</div>
                </div>
            </div>
        `;
        
        if (messageContainer) {
            // If container is empty, clear the "No messages yet" text
            if (messageContainer.innerHTML.includes('No messages yet')) {
                messageContainer.innerHTML = '';
            }
            
            messageContainer.innerHTML += tempMessage;
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }
        
        // Create request data
        const requestData = {
            type: 'direct',
            recipient: recipientId,
            content: content
        };
        
        // Add attachment if present
        if (attachmentId) {
            requestData.attachment = attachmentId;
        }
        
        // Send to API
        fetch('/messaging/send_message/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Message sent successfully:', data);
            // Update the message with server data
            const tempElement = document.getElementById(tempId);
            if (tempElement) {
                tempElement.querySelector('.message-time').textContent = data.timestamp;
                
                // Update attachment if present
                if (data.attachment) {
                    const attachmentSection = tempElement.querySelector('.pdf-attachment');
                    if (attachmentSection) {
                        const downloadLink = attachmentSection.querySelector('.pdf-attachment-download');
                        if (downloadLink) {
                            downloadLink.innerHTML = '<i class="fas fa-download"></i>';
                            downloadLink.href = data.attachment.url;
                            downloadLink.target = '_blank';
                        }
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error sending message:', error);
            // Show error state
            const tempElement = document.getElementById(tempId);
            if (tempElement) {
                tempElement.querySelector('.message-time').textContent = `${timeString} (Failed to send)`;
                tempElement.querySelector('.message-time').style.color = 'red';
            }
        });
    }
    
    // Send group message to API with attachment support
    function sendGroupMessage(groupId, content, attachmentId) {
        const messageContainer = document.getElementById('messageContainer');
        
        // Add message to UI first for responsive feel
        const tempId = 'temp-' + Date.now();
        const now = new Date();
        const hours = now.getHours() % 12 || 12;
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const ampm = now.getHours() >= 12 ? 'PM' : 'AM';
        const timeString = `${hours}:${minutes} ${ampm}`;
        
        let attachmentHtml = '';
        if (attachmentId && selectedPdfName) {
            attachmentHtml = `
                <div class="pdf-attachment">
                    <i class="fas fa-file-pdf"></i>
                    <div class="pdf-attachment-name">${selectedPdfName}</div>
                    <span class="pdf-attachment-download">
                        <i class="fas fa-clock"></i>
                    </span>
                </div>
            `;
        }
        
        const tempMessage = `
            <div class="message-item sent" id="${tempId}">
                <div class="message-bubble">
                    <div class="message-sender">You (${currentUsername})</div>
                    <div class="message-text">${content}</div>
                    ${attachmentHtml}
                    <div class="message-time">${timeString} (Sending...)</div>
                </div>
            </div>
        `;
        
        if (messageContainer) {
            // If container is empty, clear the "No messages yet" text
            if (messageContainer.innerHTML.includes('No messages yet')) {
                messageContainer.innerHTML = '';
            }
            
            messageContainer.innerHTML += tempMessage;
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }
        
        // Create request data
        const requestData = {
            type: 'group',
            group: groupId,
            content: content
        };
        
        // Add attachment if present
        if (attachmentId) {
            requestData.attachment = attachmentId;
        }
        
        // Send to API
        fetch('/messaging/send_message/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Group message sent successfully:', data);
            // Update the message with server data
            const tempElement = document.getElementById(tempId);
            if (tempElement) {
                tempElement.querySelector('.message-time').textContent = data.timestamp;
                
                // Update attachment if present
                if (data.attachment) {
                    const attachmentSection = tempElement.querySelector('.pdf-attachment');
                    if (attachmentSection) {
                        const downloadLink = attachmentSection.querySelector('.pdf-attachment-download');
                        if (downloadLink) {
                            downloadLink.innerHTML = '<i class="fas fa-download"></i>';
                            downloadLink.href = data.attachment.url;
                            downloadLink.target = '_blank';
                        }
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error sending group message:', error);
            // Show error state
            const tempElement = document.getElementById(tempId);
            if (tempElement) {
                tempElement.querySelector('.message-time').textContent = `${timeString} (Failed to send)`;
                tempElement.querySelector('.message-time').style.color = 'red';
            }
        });
    }
    
    // Create a new group
    function createGroup(name, members) {
        fetch('/messaging/create_group/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                name: name,
                members: members
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Add new group to the list
            const groupList = document.querySelector('.group-list');
            if (groupList) {
                // Create new group item
                const newGroup = document.createElement('a');
                newGroup.href = 'javascript:void(0);';
                newGroup.className = 'list-group-item list-group-item-action group-item';
                newGroup.setAttribute('data-id', data.id);
                newGroup.innerHTML = `
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-users mr-2 text-primary"></i>
                            <span>${data.name}</span>
                        </div>
                    </div>
                `;
                
                // Add click handler to the new group
                newGroup.addEventListener('click', function() {
                    showChatInterface(data.name, data.id, 'group');
                    loadGroupMessages(data.id);
                });
                
                // Add to list
                groupList.appendChild(newGroup);
                
                // Switch to groups tab
                document.getElementById('group-messages-tab').click();
                
                // Clear the form
                document.getElementById('groupName').value = '';
                document.querySelectorAll('.member-list input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
        })
        .catch(error => {
            console.error('Error creating group:', error);
            alert('Failed to create group. Please try again.');
        });
    }
    
    // Helper function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Poll for new messages every 3 seconds if in a chat
    setInterval(function() {
        if (currentChatId && currentChatType) {
            if (currentChatType === 'direct') {
                loadDirectMessages(currentChatId);
            } else if (currentChatType === 'group') {
                loadGroupMessages(currentChatId);
            }
        }
    }, 3000);
});
</script>
{% endblock %} 