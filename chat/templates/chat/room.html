{% extends 'chat/base.html' %}

{% block title %}{{ room_name }} - Chat{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Room: {{ room_name }}</h2>
        <div class="chat-container" id="chat-messages">
            {% if messages %}
                {% for message in messages %}
                    <div class="message {% if message.user.username == username %}sent{% else %}received{% endif %}">
                        <strong>{{ message.user.username }}</strong>: {{ message.content }}
                        <div class="timestamp">{{ message.timestamp|date:"M d, Y H:i" }}</div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center text-muted my-4">No messages yet. Be the first to say hello!</div>
            {% endif %}
        </div>
        <div class="input-group">
            <input type="text" id="chat-message-input" class="form-control" placeholder="Type your message here...">
            <button id="chat-message-submit" class="btn btn-primary">Send</button>
        </div>
        <div class="mt-2 text-muted small">
            <span id="connection-status">Connecting...</span>
            <span id="connection-details"></span>
            <a href="{% url 'chat:diagnostics' %}" class="ms-2 small">Run Diagnostics</a>
        </div>
        
        <!-- Error alert will show if there are WebSocket issues -->
        <div id="ws-error-alert" class="alert alert-danger mt-3" style="display: none;">
            <h5>Connection Error</h5>
            <p id="ws-error-message">Unable to establish WebSocket connection.</p>
            <div>
                <p>Please check:</p>
                <ul>
                    <li>Is Redis server running?</li>
                    <li>Is the server running with Daphne/Uvicorn?</li>
                    <li>Are Channels and channels-redis installed?</li>
                </ul>
                <a href="{% url 'chat:diagnostics' %}" class="btn btn-sm btn-outline-danger">Run Diagnostics</a>
                <button class="btn btn-sm btn-primary ms-2" id="reload-btn">Reload Page</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const roomName = '{{ room_name }}';
    const username = '{{ username }}';
    const roomId = '{{ room_id }}';
    const connectionStatus = document.getElementById('connection-status');
    const connectionDetails = document.getElementById('connection-details');
    const errorAlert = document.getElementById('ws-error-alert');
    const errorMessage = document.getElementById('ws-error-message');
    
    // Track connection attempts
    let connectionAttempts = 0;
    const MAX_ATTEMPTS = 3;
    let reconnectTimeout = null;
    
    function connectWebSocket() {
        connectionAttempts++;
        
        if (connectionAttempts > MAX_ATTEMPTS) {
            connectionStatus.textContent = 'Failed to connect after multiple attempts';
            connectionStatus.style.color = 'red';
            connectionDetails.textContent = '';
            showError('Failed to establish connection after multiple attempts. Please run diagnostics.');
            return;
        }
        
        connectionStatus.textContent = `Connecting (attempt ${connectionAttempts}/${MAX_ATTEMPTS})...`;
        
        try {
            const chatSocket = new WebSocket(
                'ws://' + window.location.host + '/ws/chat/' + encodeURIComponent(roomName) + '/'
            );
            
            chatSocket.onopen = function(e) {
                console.log('WebSocket connection established');
                connectionStatus.textContent = 'Connected';
                connectionStatus.style.color = 'green';
                connectionDetails.textContent = '';
                hideError();
                connectionAttempts = 0; // Reset attempts on successful connection
            };
            
            chatSocket.onmessage = function(e) {
                console.log('Message received:', e.data);
                try {
                    const data = JSON.parse(e.data);
                    if (data.error) {
                        console.error('Message error:', data.error);
                        return;
                    }
                    addMessage(data.username, data.message);
                } catch (error) {
                    console.error('Error parsing message:', error);
                }
            };
            
            chatSocket.onclose = function(e) {
                console.error('Chat socket closed unexpectedly', e);
                connectionStatus.textContent = 'Disconnected';
                connectionStatus.style.color = 'red';
                connectionDetails.textContent = e.wasClean ? 
                    `(Code: ${e.code})` : 
                    `(Abnormal closure, code: ${e.code})`;
                
                // Try to reconnect
                if (connectionAttempts < MAX_ATTEMPTS) {
                    reconnectTimeout = setTimeout(connectWebSocket, 3000);
                } else {
                    showError('Connection closed unexpectedly: ' + (e.reason || 'Unknown reason'));
                }
            };
            
            chatSocket.onerror = function(e) {
                console.error('WebSocket error:', e);
                connectionStatus.textContent = 'Connection error';
                connectionStatus.style.color = 'red';
                showError('WebSocket error - check console for details');
            };
            
            document.querySelector('#chat-message-input').focus();
            document.querySelector('#chat-message-input').onkeyup = function(e) {
                if (e.key === 'Enter') {
                    document.querySelector('#chat-message-submit').click();
                }
            };
            
            document.querySelector('#chat-message-submit').onclick = function(e) {
                const messageInputDom = document.querySelector('#chat-message-input');
                const message = messageInputDom.value.trim();
                if (message) {
                    try {
                        chatSocket.send(JSON.stringify({
                            'message': message,
                            'username': username
                        }));
                        // Clear input field
                        messageInputDom.value = '';
                        // Focus input field after sending
                        messageInputDom.focus();
                    } catch (error) {
                        console.error('Error sending message:', error);
                        alert('Error sending message. Please try reconnecting.');
                    }
                }
            };
            
            return chatSocket;
        } catch (error) {
            console.error('Error creating WebSocket:', error);
            connectionStatus.textContent = 'WebSocket creation error';
            connectionStatus.style.color = 'red';
            showError('Failed to create WebSocket: ' + error.message);
            
            if (connectionAttempts < MAX_ATTEMPTS) {
                reconnectTimeout = setTimeout(connectWebSocket, 3000);
            }
            
            return null;
        }
    }
    
    function addMessage(username, message) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');
        
        if (username === '{{ username }}') {
            messageElement.classList.add('sent');
        } else {
            messageElement.classList.add('received');
        }
        
        messageElement.innerHTML = `
            <strong>${username}</strong>: ${message}
            <div class="timestamp">${new Date().toLocaleString()}</div>
        `;
        
        document.querySelector('#chat-messages').appendChild(messageElement);
        document.querySelector('#chat-messages').scrollTop = document.querySelector('#chat-messages').scrollHeight;
    }
    
    function showError(message) {
        errorMessage.textContent = message;
        errorAlert.style.display = 'block';
    }
    
    function hideError() {
        errorAlert.style.display = 'none';
    }
    
    // Scroll to the bottom of the chat
    document.querySelector('#chat-messages').scrollTop = document.querySelector('#chat-messages').scrollHeight;
    
    // Start connection
    const socket = connectWebSocket();
    
    // Add reload button handler
    document.getElementById('reload-btn').addEventListener('click', function() {
        window.location.reload();
    });
    
    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        if (reconnectTimeout) {
            clearTimeout(reconnectTimeout);
        }
    });
</script>
{% endblock %} 