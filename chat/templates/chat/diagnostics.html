{% extends 'chat/base.html' %}

{% block title %}Chat Diagnostics{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Chat System Diagnostics</h2>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>System Status</h5>
            </div>
            <div class="card-body">
                <p><strong>Total Rooms:</strong> {{ room_count }}</p>
                <p><strong>Total Messages:</strong> {{ message_count }}</p>
                <p><strong>Current User:</strong> {{ username }}</p>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>WebSocket Test</h5>
            </div>
            <div class="card-body">
                <p id="ws-status">WebSocket Status: Not connected</p>
                <div id="ws-debug">
                    <!-- Connection logs will appear here -->
                </div>
                <div class="mt-3">
                    <button id="test-ws-btn" class="btn btn-primary">Test WebSocket Connection</button>
                    <button id="check-env-btn" class="btn btn-secondary ms-2">Check Environment</button>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>ASGI Configuration</h5>
            </div>
            <div class="card-body">
                <p>For WebSockets to work properly, you need:</p>
                <ol>
                    <li>A running Redis server (for channel layers)</li>
                    <li>An ASGI server like Daphne, Uvicorn, or similar</li>
                    <li>Proper ASGI configuration in <code>chat_project/asgi.py</code></li>
                </ol>
                <div class="alert alert-info">
                    <h6>Common Issues:</h6>
                    <ul>
                        <li>Redis server not running (needed for Channels)</li>
                        <li>Running with <code>runserver</code> instead of Daphne/Uvicorn</li>
                        <li>Missing <code>INSTALLED_APPS</code> configuration for <code>channels</code></li>
                        <li>Incorrect routing in <code>asgi.py</code></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>Recent Messages</h5>
            </div>
            <div class="card-body">
                {% if latest_messages %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Room</th>
                                <th>Message</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for message in latest_messages %}
                            <tr>
                                <td>{{ message.id }}</td>
                                <td>{{ message.user.username }}</td>
                                <td>{{ message.room.name }}</td>
                                <td>{{ message.content }}</td>
                                <td>{{ message.timestamp }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>No messages found in the database.</p>
                {% endif %}
            </div>
        </div>
        
        <div class="text-center mt-4">
            <a href="{% url 'chat:index' %}" class="btn btn-secondary">Back to Chat Rooms</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/chat_test.js"></script>
<script src="/static/js/websocket_debug.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Test WebSocket connection
        document.getElementById('test-ws-btn').addEventListener('click', function() {
            const wsUrl = 'ws://' + window.location.host + '/ws/chat/test_room/';
            debugWebSocketConnection(wsUrl);
        });
        
        // Check environment
        document.getElementById('check-env-btn').addEventListener('click', function() {
            checkServerEnvironment();
        });
    });
</script>
{% endblock %} 